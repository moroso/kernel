/* console_test.mb: basic test of console server.  Allocates a buffer and
 * makes a request to use the buffer with the console.
 * makes a request to use the buffer with the console.
*/

use syslib::{abscond, mailbox_new, mailbox_remove, new_vid_buffer};
use server::new_server;
use console::{CONSOLE_SERVER_ID, use_console};

static BUFFER: *u8 = 0xdead0000 as *u8;

const NUM_CONSOLE_THREADS: u32 = 16;

fn putpixel(buf: *u8, x: u32, y: u32, r: u8, g: u8, b: u8) {
    buf[(y*800+x)*3 + 0] = b;
    buf[(y*800+x)*3 + 1] = g;
    buf[(y*800+x)*3 + 2] = r;
}

fn draw_stuff(buf: *u8) {
    let i: u32 = 0;
    let j: u32 = 0;

    for (i = 0; i < 0x100; i += 1) {
        for (j = 0; j < 50; j += 1) {
            putpixel(buf, 400 - 256 + i, j, i as u8, 0, 0);
            putpixel(buf, 400 - 256 + i, j + 50, 0, i as u8, 0);
            putpixel(buf, 400 - 256 + i, j + 100, 0, 0, i as u8);

            putpixel(buf, 400 + 255 - i, j, i as u8, 0, 0);
            putpixel(buf, 400 + 255 - i, j + 50, 0, i as u8, 0);
            putpixel(buf, 400 + 255 - i, j + 100, 0, 0, i as u8);
        }
    }

    for (i = 0; i < 0x100; i += 1) {
        for (j = 0; j < 0x100; j += 1) {
            putpixel(buf, i + 400 - 128, j + 200, i as u8, j as u8, (i ^ j) as u8);
        }
    }
}

fn main() -> i32 {

    /*** initialize console server; blocks until server is set up ***/
    let new_mb = mailbox_new();
    if (new_mb < 0) {
        printf!("ERROR: initializing new mailbox\n");
        abscond(-1);
    }
    let console_mb: i32;
    if ((console_mb = new_server(CONSOLE_SERVER_ID, NUM_CONSOLE_THREADS, new_mb)) < 0) {
        printf!("ERROR: initializing console server\n");
        abscond(-1);
    }
    mailbox_remove(new_mb as u32);

    /* TODO buffer allocation syscall; will look something
     * like get_buffer(addr: *u8, size: u32) -> i32
     * maps a buffer at addr and associates it with a buffer id */
    let buffer_id = 4;

    // perform buffer operations

    /*** request to use new buffer with console ***/
    if (use_console(console_mb as u32, BUFFER, -1) < 0) {
        printf!("ERROR: console\n");
        abscond(-1);
    }

    printf!("Buffer: %x\n", BUFFER);
    draw_stuff(BUFFER);

    printf!("***SUCCESS***\n");
    abscond(0);
    0
}
