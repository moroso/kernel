/* ipc_test.mb 
 * Test of long IPC; repls a child thread, and then sends the page 0xdeadb000 to it
 * Author: Amanda M. Watson
*/

mod syslib;


fn main() -> i32 {

    while(true) {
        let ret = syslib::repl();
        let args: syslib::ipc_args;
        args.dest_id = 0;
        let message: u32 = 4;
        args.short_src.addr = &message as *u8;
        args.long_src.len = 0;
        args.short_src.len = 4;
        let dest: u32 = 0;
        args.short_dest.addr = &dest as *u8;
        args.short_dest.len = 4;

        if (ret != 0) {
            args.dest_id = ret;
            syslib::ipc_send(&args); 
            printf!("thread %d returned from send\n", syslib::get_tid());
        }
        else {
            syslib::ipc_recv(&args);
            printf!("thread %d returned from recv (%d)\n", syslib::get_tid(),
                    dest);

            syslib::abscond(1);

        }
    }
    0
}
